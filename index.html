<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Squid AI - Enhanced Settings</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Updated Firebase SDK v9 -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <style>
        :root {
            --bg-dark: #0c0c14;
            --primary: #9d4dff;
            --secondary: #1a1a25;
            --text-light: #f0f0ff;
            --accent: #00e0d0;
            --border-radius: 20px;
            --card-bg: rgba(30, 30, 46, 0.6);
            --input-bg: rgba(40, 40, 56, 0.4);
            --hover-light: rgba(255,255,255,0.15);
            --glass-bg: rgba(22, 22, 40, 0.4);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glow: 0 0 20px rgba(157, 77, 255, 0.3);
            /* VIP & Streak Colors */
            --vip-gold: #ffd700;
            --vip-purple: #8a2be2;
            --streak-fire: #ffae42;
        }
        
        body.light-mode {
            --bg-dark: #f5f7ff;
            --primary: #9147ff;
            --secondary: #e4e6fa;
            --text-light: #05051a;
            --accent: #00b5ad;
            --card-bg: rgba(255, 255, 255, 0.8);
            --input-bg: rgba(230, 230, 250, 0.6);
            --hover-light: rgba(0,0,0,0.05);
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(0, 0, 0, 0.05);
            --glow: 0 0 20px rgba(145, 71, 255, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--bg-dark) 0%, #1a1a2e 100%);
            color: var(--text-light);
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.3s, color 0.3s;
        }
        
        body::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 10% 20%, rgba(157, 77, 255, 0.15) 0%, transparent 40%),
                        radial-gradient(circle at 90% 80%, rgba(0, 224, 208, 0.15) 0%, transparent 40%);
            pointer-events: none;
            z-index: -1;
        }

        /* Loader */
        .loader-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            z-index: 10;
        }
        .loader {
            border: 4px solid var(--secondary);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
            position: relative;
        }
        .loader::after {
            content: '';
            position: absolute;
            top: -6px;
            left: -6px;
            right: -6px;
            bottom: -6px;
            border: 4px solid transparent;
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            animation: spin 1.5s cubic-bezier(0.5, 0, 0.5, 1) infinite;
            animation-delay: 0.3s;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Login Container */
        .login-container {
            display: none;
            width: 100%;
            max-width: 440px;
            padding: 40px;
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border-radius: var(--border-radius);
            border: 1px solid var(--glass-border);
            box-shadow: 0 15px 35px rgba(0,0,0,0.2), var(--glow);
            text-align: center;
            transition: transform 0.4s ease, opacity 0.4s ease;
            position: relative;
            overflow: hidden;
            z-index: 2;
        }
        
        .login-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(157, 77, 255, 0.1) 0%, transparent 70%);
            z-index: -1;
        }

        .login-logo {
            font-size: 90px;
            margin-bottom: 30px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 5px 15px rgba(157, 77, 255, 0.3));
        }
        
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .input-group {
            position: relative;
        }

        .input-group i {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary);
            font-size: 18px;
            z-index: 2;
        }

        .login-input {
            width: 100%;
            padding: 18px 18px 18px 55px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 50px;
            background: var(--input-bg);
            color: var(--text-light);
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
            position: relative;
            z-index: 1;
        }

        .login-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(157, 77, 255, 0.3);
        }

        .login-button {
            padding: 18px;
            background: linear-gradient(135deg, var(--primary), #7a2fff);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
            box-shadow: 0 5px 15px rgba(157, 77, 255, 0.3);
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        
        .login-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #7a2fff, var(--primary));
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .login-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(157, 77, 255, 0.5);
        }
        
        .login-button:hover::before {
            opacity: 1;
        }

        .form-footer {
            margin-top: 20px;
            font-size: 14px;
            color: #aaa;
        }

        .form-footer a {
            color: var(--accent);
            text-decoration: none;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .form-footer a:hover {
            text-decoration: underline;
            color: var(--primary);
        }

        .error-message {
            color: #ff6b6b;
            font-size: 14px;
            margin-top: -15px;
            margin-bottom: 5px;
            text-align: left;
            padding-left: 20px;
            display: none;
            min-height: 20px;
        }
        #generalError {
            text-align: center;
            margin-top: -10px;
            margin-bottom: 10px;
            padding: 0;
        }

        /* App Container */
        .app-container {
            width: 100%;
            height: 100%;
            max-width: 500px;
            max-height: 900px;
            display: none;
            flex-direction: column;
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            box-shadow: 0 0 40px rgba(0,0,0,0.3), var(--glow);
            position: relative;
            overflow: hidden;
            border-radius: 30px;
            border: 1px solid var(--glass-border);
            transition: all 0.3s ease;
            z-index: 2;
        }
        
        /* Header */
        .app-header {
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            z-index: 10;
            border-bottom: 1px solid var(--glass-border);
            transition: all 0.3s;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .app-logo {
            font-size: 34px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 3px 8px rgba(157, 77, 255, 0.2));
        }

        .app-title {
            font-weight: 700;
            font-size: 20px;
            letter-spacing: 0.5px;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        #streakCounter {
            background-color: var(--input-bg);
            color: var(--streak-fire);
            padding: 8px 12px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 700;
            display: none; /* Hidden by default */
            align-items: center;
            gap: 6px;
            border: 1px solid var(--glass-border);
            text-shadow: 0 0 5px var(--streak-fire);
            transition: all 0.3s ease;
        }

        .header-icon {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--input-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid var(--glass-border);
            color: var(--text-light);
            font-size: 18px;
            backdrop-filter: blur(5px);
        }
        
        .header-icon:hover {
            transform: scale(1.08);
            background: rgba(157, 77, 255, 0.2);
            box-shadow: 0 0 15px rgba(157, 77, 255, 0.2);
        }
        
        .content-wrapper {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .main-content, .chat-container, .settings-container, .game-container, .info-container, .leaderboard-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            background: transparent;
            padding: 25px;
            animation: fadeIn 0.4s ease;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .welcome-text {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 40px;
            text-align: center;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 3px 8px rgba(157, 77, 255, 0.2));
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 100%;
            max-width: 400px;
            margin-bottom: 30px;
        }

        .action-button {
            padding: 22px;
            background: var(--card-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            color: var(--text-light);
            font-size: 17px;
            font-weight: 600;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: left;
            backdrop-filter: blur(5px);
            position: relative;
            overflow: hidden;
        }
        
        .action-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(157, 77, 255, 0.1), rgba(0, 224, 208, 0.1));
            z-index: 0;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .action-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            border-color: rgba(157, 77, 255, 0.3);
        }
        
        .action-button:hover::before {
            opacity: 1;
        }
        
        body.light-mode .action-button:hover {
            background: rgba(255, 255, 255, 0.9);
        }

        .action-button .icon {
            margin-right: 15px;
            font-size: 26px;
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 1;
        }

        .chat-container {
            display: none;
            flex-direction: column;
            padding: 0;
        }

        .limit-counter {
            padding: 5px 25px 10px;
            text-align: right;
            font-size: 12px;
            color: #aaa;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .chat-container .chat-messages {
            padding-top: 10px;
        }
        #chatContainer .chat-messages {
             padding-top: 25px;
        }


        .message {
            max-width: 85%;
            padding: 18px;
            border-radius: 22px;
            word-wrap: break-word;
            animation: fadeInUp 0.4s ease;
            position: relative;
            line-height: 1.5;
            transition: background-color 0.3s, color 0.3s;
            backdrop-filter: blur(5px);
        }
        
        .message::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            bottom: 0;
        }

        .user-message {
            align-self: flex-end;
            background: linear-gradient(135deg, var(--primary), #7a2fff);
            color: white;
            border-bottom-right-radius: 5px;
            box-shadow: 0 5px 15px rgba(157, 77, 255, 0.2);
            animation-name: fadeInRight;
        }
        
        .user-message::after {
            right: -10px;
            background: linear-gradient(135deg, var(--primary), #7a2fff);
            clip-path: polygon(0 0, 100% 100%, 100% 0);
            transform: rotate(-45deg);
            bottom: 10px;
        }

        .ai-message {
            align-self: flex-start;
            background: var(--card-bg);
            border: 1px solid var(--glass-border);
            border-bottom-left-radius: 5px;
            animation-name: fadeInLeft;
        }
        
        .ai-message::after {
            left: -10px;
            background: var(--card-bg);
            border: 1px solid var(--glass-border);
            clip-path: polygon(0 0, 0 100%, 100% 0);
            transform: rotate(45deg);
            bottom: 10px;
        }

        .message-time { 
            font-size: 11px; 
            opacity: 0.8; 
            margin-top: 8px; 
            text-align: right; 
            font-weight: 300;
        }
        
        .message-image {
            max-width: 100%;
            border-radius: 15px;
            margin-bottom: 10px;
            display: block;
        }

        .typing-indicator {
            display: flex; 
            align-items: center; 
            padding: 18px; 
            background: var(--card-bg);
            border: 1px solid var(--glass-border);
            border-radius: 22px; 
            border-bottom-left-radius: 5px; 
            align-self: flex-start;
            margin-bottom: 15px; 
            width: 110px; 
            backdrop-filter: blur(5px);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.8; }
            50% { opacity: 1; }
            100% { opacity: 0.8; }
        }
        
        .typing-dot {
            width: 9px; 
            height: 9px; 
            background-color: var(--primary); 
            border-radius: 50%;
            margin: 0 5px; 
            animation: typingAnimation 1.4s infinite ease-in-out;
        }
        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        .chat-input-container {
            padding: 15px 20px; 
            display: flex; 
            align-items: center;
            gap: 10px;
            background: var(--glass-bg); 
            border-top: 1px solid var(--glass-border);
            backdrop-filter: blur(10px);
            flex-wrap: wrap;
        }

        .chat-input {
            flex: 1; 
            min-width: 50px;
            padding: 15px 20px; 
            border: 1px solid var(--glass-border); 
            border-radius: 50px;
            background: var(--input-bg); 
            color: var(--text-light); 
            font-size: 16px;
            outline: none; 
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }
        
        .chat-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(157, 77, 255, 0.2);
        }
        .chat-input:disabled {
            background: rgba(40, 40, 56, 0.2);
            cursor: not-allowed;
        }


        .send-button {
            width: 50px; 
            height: 50px; 
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), #7a2fff); 
            border: none;
            color: white; 
            display: flex; 
            justify-content: center; 
            align-items: center;
            cursor: pointer; 
            transition: all 0.3s ease; 
            font-size: 18px; 
            box-shadow: 0 5px 15px rgba(157, 77, 255, 0.3);
            flex-shrink: 0;
        }
        
        .send-button:hover {
            transform: scale(1.08) rotate(10deg);
            box-shadow: 0 7px 20px rgba(157, 77, 255, 0.4);
        }
        .send-button:disabled {
            background: var(--secondary);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .attachment-button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--input-bg);
            border: 1px solid var(--glass-border);
            color: var(--primary);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 18px;
            flex-shrink: 0;
        }
        
        .attachment-button:hover {
            background: rgba(157, 77, 255, 0.2);
            transform: scale(1.05);
        }
        .attachment-button:disabled {
            background: var(--secondary);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            color: #888;
        }

        #hindiImagePreviewContainer {
            padding: 0 20px 10px 20px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: flex-start;
        }
        .image-preview {
            position: relative;
            display: inline-block;
            background: var(--input-bg);
            padding: 8px;
            border-radius: 12px;
        }
        .image-preview img {
            max-width: 80px;
            max-height: 80px;
            border-radius: 8px;
            display: block;
        }
        .remove-preview-btn {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 22px;
            height: 22px;
            background: #ff4d4d;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            transition: transform 0.2s;
        }
        .remove-preview-btn:hover {
            transform: scale(1.1);
        }

        #adviceSuggestionsContainer {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 0 20px 15px 20px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
        }
        .suggestion-chip {
            background: var(--input-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-light);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }
        .suggestion-chip:hover {
            background: rgba(157, 77, 255, 0.2);
            border-color: var(--primary);
            transform: translateY(-2px);
        }


        .bottom-nav {
            display: flex; 
            justify-content: space-around; 
            padding: 15px 0;
            background: var(--glass-bg); 
            border-top: 1px solid var(--glass-border);
            backdrop-filter: blur(10px);
        }

        .nav-item {
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            color: #aaa;
            cursor: pointer; 
            transition: all 0.3s ease; 
            padding: 8px 15px;
            border-radius: 50px;
            position: relative;
            flex: 1;
            text-align: center;
        }
        
        .nav-item::after {
            content: '';
            position: absolute;
            bottom: 0;
            width: 0;
            height: 3px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        .nav-item.active { 
            color: var(--primary); 
        }
        
        .nav-item.active::after {
            width: 30px;
        }
        
        .nav-item:hover { 
            color: var(--primary);
            background: rgba(157, 77, 255, 0.1);
        }
        
        .nav-icon { 
            font-size: 22px; 
            margin-bottom: 5px; 
            transition: all 0.3s ease;
        }
        
        .nav-item:hover .nav-icon {
            transform: translateY(-3px);
        }
        
        .nav-label { 
            font-size: 12px;
            font-weight: 500;
        }
        
        .settings-container {
            display: none;
            flex-direction: column;
            gap: 20px;
            padding: 25px;
        }
        
        .settings-header {
            font-size: 24px;
            font-weight: 700;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .settings-header i {
            color: var(--primary);
        }
        
        .settings-item {
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            background: var(--card-bg); 
            padding: 20px; 
            border-radius: var(--border-radius);
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(5px);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .settings-item:hover {
            transform: translateX(5px);
            background: rgba(157, 77, 255, 0.1);
        }
        
        .settings-item.vip {
            border-color: transparent;
            background: linear-gradient(135deg, var(--vip-purple), var(--vip-gold), var(--vip-purple));
            background-size: 200% 200%;
            animation: vipBgAnimate 4s ease infinite;
        }
        .settings-item.vip.active-vip {
            background: linear-gradient(135deg, var(--vip-gold), #ffec8a, var(--vip-gold));
            animation: vipBgAnimate 6s ease infinite;
        }
        .settings-item.vip:hover {
            transform: translateX(5px) scale(1.02);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }
        .settings-item.vip label, .settings-item.vip i {
            color: white !important;
            text-shadow: 0 1px 3px rgba(0,0,0,0.4);
        }
        .settings-item.vip.active-vip label, .settings-item.vip.active-vip i {
            color: #4B0082 !important;
        }


        .settings-item label { 
            font-size: 17px; 
            font-weight: 500; 
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }
        
        .settings-item i {
            color: var(--primary);
            font-size: 20px;
        }
        
        .logout-button {
            width: 100%; 
            padding: 18px; 
            background: linear-gradient(135deg, #ff4d4d, #ff2d2d);
            color: white; 
            border: none;
            border-radius: var(--border-radius); 
            font-size: 17px; 
            font-weight: 600; 
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(255, 77, 77, 0.2);
            margin-top: 10px;
        }
        
        .logout-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 77, 77, 0.3);
        }

        .theme-switch { 
            position: relative; 
            display: inline-block; 
            width: 55px; 
            height: 30px; 
        }
        
        .theme-switch input { 
            opacity: 0; 
            width: 0; 
            height: 0; 
        }
        
        .slider { 
            position: absolute; 
            cursor: pointer; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background: var(--input-bg); 
            transition: .4s; 
            border-radius: 34px; 
            border: 1px solid var(--glass-border);
        }
        
        .slider:before { 
            position: absolute; 
            content: ""; 
            height: 24px; 
            width: 24px; 
            left: 3px; 
            bottom: 2.5px; 
            background: linear-gradient(135deg, var(--primary), var(--accent));
            transition: .4s; 
            border-radius: 50%; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        input:checked + .slider { 
            background: var(--primary);
        }
        
        input:checked + .slider:before { 
            transform: translateX(25px); 
            background: white;
        }

        #chatHistoryList {
            list-style: none;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .history-item {
            background: var(--card-bg);
            padding: 18px;
            border-radius: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(5px);
            position: relative;
        }
        
        .history-item:hover { 
            transform: translateY(-3px);
            background: rgba(157, 77, 255, 0.1);
            border-color: rgba(157, 77, 255, 0.3);
        }
        
        .history-title {
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            max-width: 70%;
            font-weight: 500;
        }

        .lang-badge {
            background-color: var(--primary);
            color: white;
            padding: 3px 8px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 10px;
        }
        
        .history-actions button {
            background: none; 
            border: none; 
            color: #aaa; 
            cursor: pointer; 
            font-size: 18px; 
            margin-left: 12px;
            transition: all 0.2s ease;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .history-actions button:hover { 
            color: var(--primary);
            background: rgba(157, 77, 255, 0.1);
        }
        
        #noHistoryMessage { 
            text-align: center; 
            color: #aaa; 
            margin-top: 30px; 
            font-style: italic;
        }
        
        .game-container {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
        }
        
        .game-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 3px 8px rgba(157, 77, 255, 0.2));
        }
        
        .round-title {
            font-size: 18px;
            margin-bottom: 15px;
        }
        
        .timer-display {
            font-size: 18px;
            margin: 10px 0 20px;
            background: var(--card-bg);
            padding: 10px 20px;
            border-radius: 50px;
            display: inline-block;
            border: 1px solid var(--glass-border);
        }
        
        .emoji-container {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            margin: 20px 0;
        }
        
        .emoji {
            font-size: 2.5rem;
            cursor: pointer;
            transition: transform 0.2s;
            background: var(--card-bg);
            padding: 15px;
            border-radius: 15px;
            border: 1px solid var(--glass-border);
        }
        
        .emoji:hover {
            transform: scale(1.1);
            background: rgba(157, 77, 255, 0.2);
        }
        
        .game-button {
            padding: 12px 24px;
            font-size: 16px;
            background: linear-gradient(135deg, var(--primary), #7a2fff);
            border: none;
            color: white;
            border-radius: 50px;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(157, 77, 255, 0.3);
        }
        
        .game-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(157, 77, 255, 0.5);
        }
        
        .iq-result {
            font-size: 24px;
            margin-top: 20px;
            font-weight: bold;
            background: linear-gradient(135deg, var(--accent), #00c6ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .info-container {
            display: none;
            flex-direction: column;
            gap: 25px;
            padding: 25px;
            height: 100%;
            overflow-y: auto;
        }
        
        .info-header {
            display: flex;
            align-items: center;
            gap: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--glass-border);
        }
        
        .info-header h2 {
            font-size: 24px;
            font-weight: 700;
        }
        
        .info-header i {
            color: var(--primary);
            font-size: 28px;
        }
        
        .info-content {
            background: var(--card-bg);
            padding: 25px;
            border-radius: var(--border-radius);
            border: 1px solid var(--glass-border);
            line-height: 1.7;
            backdrop-filter: blur(5px);
        }
        
        .info-content h3 {
            color: var(--primary);
            margin: 20px 0 10px;
            font-size: 20px;
        }
        
        .info-content ul {
            padding-left: 25px;
            margin: 10px 0;
        }
        
        .info-content li {
            margin-bottom: 8px;
        }
        
        .back-button {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--input-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-light);
            padding: 12px 20px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
            backdrop-filter: blur(5px);
            width: fit-content;
        }
        
        .back-button:hover {
            background: rgba(157, 77, 255, 0.1);
            transform: translateX(-5px);
        }
        
        .highlight-box {
            background: rgba(157, 77, 255, 0.1);
            border-left: 3px solid var(--primary);
            padding: 15px;
            border-radius: 0 10px 10px 0;
            margin: 15px 0;
        }
        
        .profile-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        .profile-header .value {
            font-size: 16px;
            flex-grow: 1;
        }
        .vip-badge {
            color: var(--vip-gold);
            font-size: 20px;
            text-shadow: 0 0 8px rgba(255, 215, 0, 0.7);
        }

        .profile-field {
            margin-bottom: 20px;
        }
        .profile-field label {
            display: block;
            font-size: 14px;
            color: #aaa;
            margin-bottom: 8px;
        }
        .profile-field .value {
            font-size: 16px;
            background: var(--input-bg);
            padding: 15px;
            border-radius: 15px;
        }
        .profile-field input {
             width: 100%;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            background: var(--input-bg);
            color: var(--text-light);
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
        }
        .profile-field input:focus {
            border-color: var(--primary);
        }
        #profileStatus {
            font-size: 14px;
            margin-top: 10px;
            min-height: 20px;
            text-align: center;
        }
        .success { color: var(--accent); }
        .fail { color: #ff6b6b; }
        
        .leaderboard-container {
            display: none;
            flex-direction: column;
            gap: 15px;
        }
        #leaderboardList {
            list-style: none;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .leaderboard-item {
            display: flex;
            align-items: center;
            background: var(--card-bg);
            padding: 15px 20px;
            border-radius: 15px;
            border: 1px solid var(--glass-border);
            transition: transform 0.2s ease;
        }
        .leaderboard-item.is-vip {
             border-left: 4px solid var(--vip-gold);
        }
        .leaderboard-item:hover {
            transform: scale(1.02);
            border-color: var(--primary);
        }
        .leaderboard-item:nth-child(1) { border-color: var(--vip-gold); box-shadow: 0 0 15px rgba(255, 215, 0, 0.3); }
        .leaderboard-item:nth-child(2) { border-color: #c0c0c0; }
        .leaderboard-item:nth-child(3) { border-color: #cd7f32; }
        .leaderboard-rank {
            font-size: 20px;
            font-weight: 700;
            width: 40px;
            text-align: center;
            margin-right: 15px;
            color: var(--primary);
        }
        .leaderboard-item:nth-child(1) .leaderboard-rank { color: var(--vip-gold); }
        .leaderboard-item:nth-child(2) .leaderboard-rank { color: #c0c0c0; }
        .leaderboard-item:nth-child(3) .leaderboard-rank { color: #cd7f32; }
        .leaderboard-name {
            flex-grow: 1;
            font-size: 17px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .leaderboard-score {
            font-size: 16px;
            font-weight: 600;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .leaderboard-score i {
            font-size: 14px;
            margin-right: 5px;
        }

        .vip-feature-list {
            list-style: none;
            padding: 0;
            margin: 15px 0;
        }
        .vip-feature-list li {
            display: flex;
            align-items: center;
            font-size: 17px;
            margin-bottom: 15px;
        }
        .vip-feature-list i {
            color: var(--vip-gold);
            font-size: 20px;
            margin-right: 15px;
            text-shadow: 0 0 8px rgba(255, 215, 0, 0.5);
        }
        .unlock-vip-button {
            width: 100%;
            padding: 18px;
            font-size: 18px;
            font-weight: 700;
            letter-spacing: 1px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
            color: #0c0c14;
            background: linear-gradient(45deg, var(--vip-purple), var(--vip-gold), var(--vip-purple));
            background-size: 200% 200%;
            animation: vipBgAnimate 4s ease infinite;
            box-shadow: 0 5px 15px rgba(138, 43, 226, 0.4);
        }
        .unlock-vip-button:hover {
            transform: scale(1.03);
            box-shadow: 0 7px 20px rgba(255, 215, 0, 0.5);
        }
        #streakRedeemContainer {
            margin-top: 30px;
            padding: 20px;
            background: var(--input-bg);
            border-radius: var(--border-radius);
            text-align: center;
            border: 1px solid var(--glass-border);
        }
        #streakProgressText {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        #streakProgressText .fire-icon { color: var(--streak-fire); }
        .redeem-streak-button {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, var(--streak-fire), #ff7e5f);
            color: white;
            box-shadow: 0 4px 10px rgba(255, 174, 66, 0.3);
        }
        .redeem-streak-button:disabled {
            background: var(--secondary);
            color: #888;
            cursor: not-allowed;
            box-shadow: none;
        }
        .redeem-streak-button:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(255, 174, 66, 0.4);
        }

        /* RESTORED: Ad Banner Styles */
        #adBannerContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 1000;
            display: none; /* Toggled by JS */
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(8px);
        }
        #adContainer {
            width: 90%;
            max-width: 800px;
            height: 500px;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(128, 0, 128, 0.6);
            position: relative;
            border: 1px solid rgba(255, 215, 0, 0.2);
            background: #000;
        }
        #adContainer canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        #adContent {
            position: relative;
            z-index: 2;
            padding: 25px;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            gap: 15px;
        }
        #adContent .header { text-align: center; }
        #adContent .title {
            font-size: 48px;
            font-weight: 900;
            background: linear-gradient(45deg, var(--vip-gold), #ff69b4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 15px rgba(128, 0, 128, 0.7);
            margin-bottom: 5px;
            letter-spacing: 1px;
        }
        #adContent .subtitle {
            color: var(--vip-gold);
            font-size: 20px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        #adContent .features-container {
            background: linear-gradient(135deg, var(--vip-purple), var(--vip-gold));
            border-radius: 12px;
            padding: 2px;
            flex-grow: 1;
            display: flex;
        }
        #adContent .features {
            background: rgba(0, 0, 0, 0.75);
            border-radius: 10px;
            padding: 15px;
            backdrop-filter: blur(8px);
            width: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        #adContent .feature {
            color: #fff;
            font-size: 19px;
            margin: 9px 0;
            display: flex;
            align-items: center;
        }
        #adContent .feature::before {
            content: "âœ“";
            color: var(--vip-gold);
            font-weight: bold;
            font-size: 22px;
            margin-right: 12px;
            text-shadow: 0 0 8px rgba(255, 215, 0, 0.8);
        }
        #adContent .button-container { text-align: center; }
        #adContent .vip-button {
            background: linear-gradient(45deg, var(--vip-purple), var(--vip-gold), var(--vip-purple));
            background-size: 200% 200%;
            color: #000;
            font-size: 24px;
            font-weight: 900;
            padding: 14px 30px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            letter-spacing: 1px;
            box-shadow: 0 5px 20px rgba(138, 43, 226, 0.5), 0 0 25px rgba(255, 215, 0, 0.5);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            z-index: 3;
            animation: adPulse 1.5s infinite, vipBgAnimate 4s ease infinite;
        }
        #adContent .vip-button:hover {
            transform: scale(1.05);
            box-shadow: 0 7px 25px rgba(138, 43, 226, 0.7), 0 0 30px rgba(255, 215, 0, 0.7);
        }
        #adContent .vip-button:hover::after { transform: rotate(360deg); }
        #adContent .vip-button::after {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0) 60%);
            transform: rotate(0deg);
            transition: transform 0.7s ease;
        }
        #adCountdown {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.8);
            color: var(--vip-gold);
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            font-weight: bold;
            z-index: 10;
            border: 2px solid var(--vip-gold);
            box-shadow: 0 0 12px rgba(255, 215, 0, 0.6);
        }
        #adCountdown.tick { animation: countdownTick 0.3s ease-out; }
        @keyframes adPulse { 0% { transform: scale(1); } 50% { transform: scale(1.03); } 100% { transform: scale(1); } }
        @keyframes adFadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        #adContent .animated-entry { animation: adFadeInUp 0.8s ease-out forwards; opacity: 0; }
        @keyframes countdownTick { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }


        /* Animations */
        @keyframes vipBgAnimate {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes typingAnimation { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-6px); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInLeft { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes fadeInRight { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { translateY(0px); } }
        .app-logo, .login-logo { animation: float 4s ease-in-out infinite; }

        /* Responsive */
        @media (max-width: 500px) {
            .app-container { max-width: 100%; max-height: 100%; border-radius: 0; }
            .login-container { width: 90%; padding: 30px; }
            .app-header { padding: 15px 20px; }
            .action-button { padding: 18px; }
            .chat-messages { padding: 15px; }
            .emoji { font-size: 2rem; padding: 12px; }
            .chat-input-container { padding: 10px 15px; gap: 8px; }
            .chat-input { padding: 12px 15px; font-size: 14px; }
            .attachment-button, .send-button { width: 45px; height: 45px; font-size: 16px; }
            #adContent .title { font-size: 32px; }
            #adContent .feature { font-size: 16px; }
            #adContent .vip-button { font-size: 18px; padding: 12px 25px; }
            .nav-item { padding: 8px 10px; }
        }
        
        @media (max-width: 380px) {
            .chat-input { font-size: 13px; padding: 10px 15px; }
            .nav-label { font-size: 11px; }
            #streakCounter { font-size: 12px; padding: 6px 10px; gap: 4px; }
        }

    </style>
</head>
<body>

    <div class="loader-container" id="loaderContainer">
        <div class="loader"></div>
        <p>Initializing Squid AI...</p>
    </div>

    <div class="login-container" id="loginContainer">
        <div class="login-logo">ðŸ¦‘</div>
        <div class="login-form">
            <div class="input-group">
                <i class="fas fa-envelope"></i>
                <input type="email" class="login-input" id="emailInput" placeholder="Email address" autocomplete="email">
            </div>
            <div class="error-message" id="emailError">Please enter a valid email</div>
            <div class="input-group">
                <i class="fas fa-lock"></i>
                <input type="password" class="login-input" id="passwordInput" placeholder="Password" autocomplete="current-password">
            </div>
            <div class="error-message" id="passwordError">Password must be at least 6 characters</div>
            <div class="error-message" id="generalError"></div>
            <button class="login-button" id="authButton">Log In</button>
            <div class="form-footer">
                <span id="formFooterText">Don't have an account?</span> <a href="#" id="toggleAuthModeLink">Sign Up</a>
            </div>
        </div>
    </div>

    <div class="app-container" id="appContainer">
        <div class="app-header">
            <div class="logo-container">
                <div class="app-logo">ðŸ¦‘</div>
                <div class="app-title" id="appTitle">Squid AI</div>
            </div>
            <div class="header-controls">
                <div id="streakCounter">
                    <span>ðŸ”¥</span>
                    <span id="streakCount">0</span>
                </div>
                <button class="header-icon" id="settingsButton" title="Settings">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </div>

        <div class="content-wrapper">
            <!-- Main Content -->
            <div class="main-content" id="mainContent">
                <div class="welcome-text">Where should we start?</div>
                <div class="action-buttons">
                    <button class="action-button" id="adviceChatButton"><span class="icon"><i class="fas fa-hand-holding-heart"></i></span> Get Advice</button>
                    <button class="action-button" id="chatButton"><span class="icon">ðŸ’¬</span> Start a new chat</button>
                    <button class="action-button" id="hindiChatButton"><span class="icon">ðŸ‡®ðŸ‡³</span> Chat in Hindi</button>
                    <button class="action-button" id="iqButton"><span class="icon">ðŸ§ </span> IQ Calculator</button>
                    <button class="action-button" id="learnButton"><span class="icon">ðŸ“š</span> Learn about AI</button>
                    <button class="action-button" id="codeButton"><span class="icon"><i class="fas fa-code"></i></span> Create Codes</button>
                </div>
            </div>

            <!-- Chat Container (English - Uses COHERE) -->
            <div class="chat-container" id="chatContainer">
                <div class="chat-messages" id="chatMessages"></div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Ask Squid AI...">
                    <button class="send-button" id="sendButton"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>

            <!-- Advice Chat Container (Uses GEMINI) -->
            <div class="chat-container" id="adviceChatContainer">
                <div class="limit-counter" id="adviceLimitCounter"></div>
                <div class="chat-messages" id="adviceChatMessages"></div>
                <div id="adviceSuggestionsContainer">
                    <button class="suggestion-chip">I'm feeling stressed</button>
                    <button class="suggestion-chip">I need relationship advice</button>
                    <button class="suggestion-chip">How to deal with failure?</button>
                    <button class="suggestion-chip">I feel lonely</button>
                </div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="adviceChatInput" placeholder="Tell me what's on your mind...">
                    <button class="send-button" id="adviceSendButton"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>

            <!-- Hindi Chat Container -->
            <div class="chat-container" id="hindiChatContainer">
                <div class="limit-counter" id="hindiLimitCounter"></div>
                <div class="chat-messages" id="hindiChatMessages"></div>
                <div id="hindiImagePreviewContainer"></div>
                <div class="chat-input-container">
                    <button class="attachment-button" id="hindiAttachmentButton" title="Attach image"><i class="fas fa-paperclip"></i></button>
                    <input type="file" id="hindiFileInput" accept="image/jpeg, image/png, image/webp" style="display: none;">
                    <input type="text" class="chat-input" id="hindiChatInput" placeholder="à¤›à¤µà¤¿ à¤•à¥‡ à¤¸à¤¾à¤¥ à¤•à¥à¤› à¤ªà¥‚à¤›à¥‡à¤‚...">
                    <button class="send-button" id="hindiSendButton"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
            
            <!-- Settings Container -->
            <div class="settings-container" id="settingsContainer">
                <h2 class="settings-header"><i class="fas fa-cog"></i> Settings</h2>
                
                <div class="settings-item vip" id="vipMembershipBtn">
                    <label><i class="fas fa-crown"></i> <span id="vipBtnText">VIP Membership</span></label>
                    <i class="fas fa-chevron-right"></i>
                </div>
                <div class="settings-item" id="profileBtn">
                    <label><i class="fas fa-user-circle"></i> Your Profile</label>
                    <i class="fas fa-chevron-right"></i>
                </div>
                <div class="settings-item" id="howToUseBtn">
                    <label><i class="fas fa-book"></i> How to Use</label>
                    <i class="fas fa-chevron-right"></i>
                </div>
                <div class="settings-item" id="privacyPolicyBtn">
                    <label><i class="fas fa-shield-alt"></i> Privacy Policy</label>
                    <i class="fas fa-chevron-right"></i>
                </div>
                <div class="settings-item" id="securityBtn">
                    <label><i class="fas fa-lock"></i> Security</label>
                    <i class="fas fa-chevron-right"></i>
                </div>
                <div class="settings-item">
                    <label for="themeToggle"><i class="fas fa-sun"></i> Light Mode</label>
                    <label class="theme-switch">
                        <input type="checkbox" id="themeToggle">
                        <span class="slider"></span>
                    </label>
                </div>
                <div>
                    <h3 class="settings-header" style="margin-top: 20px; font-size: 20px;"><i class="fas fa-history"></i> Chat History</h3>
                     <ul id="chatHistoryList"></ul>
                     <p id="noHistoryMessage" style="display: none;">No saved chats yet.</p>
                </div>
                <div class="settings-item" style="background: none; padding: 0; margin-top: auto;">
                    <button class="logout-button" id="logoutButton">Log Out</button>
                </div>
            </div>

            <!-- VIP Membership Container -->
            <div class="info-container" id="vipMembershipContainer">
                <div class="info-header">
                    <i class="fas fa-crown" style="color: var(--vip-gold);"></i>
                    <h2>Squid VIP Membership</h2>
                </div>
                <div class="info-content">
                    <h3>Unlock Premium Features!</h3>
                    <p>Upgrade to VIP for the ultimate Squid AI experience.</p>
                    <ul class="vip-feature-list">
                        <li><i class="fas fa-trophy"></i>Show your name on global leaderboard</li>
                        <li><i class="fas fa-bolt"></i>2x limit increases on your language</li>
                        <li><i class="fas fa-id-badge"></i>Get VIP badge on your profile</li>
                        <li><i class="fas fa-ad"></i>Ad-free experience</li>
                        <li><i class="fas fa-rocket"></i>Unlock multiple VIP features</li>
                    </ul>
                    <button class="unlock-vip-button" id="unlockVipPageButton">Unlock Now (Work in Progress)</button>
                    <div id="streakRedeemContainer">
                        <p id="streakProgressText"><span class="fire-icon">ðŸ”¥</span> Your Streak: <span id="redeemStreakCount">0</span> / 30</p>
                        <button class="redeem-streak-button" id="redeemStreakButton" disabled>Redeem for 1 Month FREE VIP</button>
                    </div>
                </div>
                <button class="back-button" id="backFromVip">
                    <i class="fas fa-arrow-left"></i> Back to Settings
                </button>
            </div>
            
            <!-- Leaderboard Container -->
            <div class="leaderboard-container" id="leaderboardContainer">
                <div class="info-header">
                    <i class="fas fa-trophy" style="color: var(--vip-gold);"></i>
                    <h2>Global Leaderboard</h2>
                </div>
                <p style="text-align: center; color: #ccc; margin-top: -10px; margin-bottom: 10px;">Top monthly members. Only VIP members are shown.</p>
                <ul id="leaderboardList">
                    <!-- Leaderboard items will be injected by JS -->
                </ul>
            </div>
            
            <!-- Profile Container -->
            <div class="info-container" id="profileContainer">
                <div class="info-header">
                    <i class="fas fa-user-circle"></i>
                    <h2>Your Profile</h2>
                </div>
                <div class="info-content">
                    <div class="profile-field">
                        <label>Email Address</label>
                        <div class="profile-header">
                           <div class="value" id="profileEmail"></div>
                           <i id="profileVipBadge" class="fas fa-crown vip-badge" style="display: none;" title="VIP Member"></i>
                        </div>
                    </div>
                    <div class="profile-field">
                        <label for="profileNameInput">Your Name (for Leaderboard)</label>
                        <input type="text" id="profileNameInput" placeholder="Enter your name">
                    </div>
                    <button class="login-button" id="saveNameButton" style="width:100%;">Save Name</button>
                    <div id="profileStatus"></div>
                    
                    <h3 style="margin-top: 30px;">Security</h3>
                    <button class="back-button" id="resetPasswordButton" style="width:100%; justify-content:center;">
                        <i class="fas fa-key"></i> Send Password Reset Link
                    </button>
                </div>
                 <button class="back-button" id="backFromProfile">
                    <i class="fas fa-arrow-left"></i> Back to Settings
                </button>
            </div>


            <!-- How to Use Container -->
            <div class="info-container" id="howToUseContainer">
                <div class="info-header">
                    <i class="fas fa-book"></i>
                    <h2>How to Use Squid AI</h2>
                </div>
                
                <div class="info-content">
                    <p>Welcome to Squid AI! Here's how to make the most of your experience:</p>
                    
                    <h3>Daily Streak ðŸ”¥</h3>
                    <p>Open the app every day to increase your daily streak. Reach a 30-day streak to redeem a <strong>FREE month of VIP membership!</strong></p>

                    <h3>Getting Started</h3>
                    <ul>
                        <li><strong>Get Advice</strong>: Tap this for a friendly, supportive chat in Hinglish.</li>
                        <li><strong>New Chat</strong>: Tap the "New Chat" button to start a standard conversation.</li>
                        <li><strong>Hindi Chat</strong>: Select "Chat in Hindi" for conversations in Hindi.</li>
                        <li><strong>IQ Test</strong>: Try our fun IQ calculator game under "IQ Calculator".</li>
                    </ul>
                    
                    <h3>Chat Features</h3>
                    <ul>
                        <li>Type your message and press Enter or tap the send button.</li>
                        <li>View your chat history in the Settings menu.</li>
                        <li>In Hindi chat, tap the paperclip icon <i class="fas fa-paperclip"></i> to analyze photos.</li>
                    </ul>
                    
                    <div class="highlight-box">
                        <p><i class="fas fa-lightbulb"></i> <strong>Pro Tip</strong>: Use specific questions to get the most accurate answers from Squid AI. For example: "Explain quantum computing in simple terms" or "Write a Python function to calculate factorial".</p>
                    </div>
                    
                    <h3>Daily Limits</h3>
                    <p>To ensure fair usage for everyone:</p>
                    <ul>
                        <li>"Get Advice" and "Chat in Hindi" are limited to 50 messages per day.</li>
                        <li><strong>VIP Members get 100 messages per day!</strong></li>
                        <li>Other chats have no daily limits.</li>
                        <li>IQ game can be played unlimited times.</li>
                    </ul>
                    
                    <button class="back-button" id="backFromHowToUse">
                        <i class="fas fa-arrow-left"></i> Back to Settings
                    </button>
                </div>
            </div>
            
            <!-- Privacy Policy Container -->
            <div class="info-container" id="privacyPolicyContainer">
                <div class="info-header">
                    <i class="fas fa-shield-alt"></i>
                    <h2>Privacy Policy</h2>
                </div>
                
                <div class="info-content">
                    <p>Your privacy is important to us. This policy explains how we handle your information:</p>
                    
                    <h3>Data Collection</h3>
                    <p>We collect the following information:</p>
                    <ul>
                        <li>Email address and display name for authentication purposes</li>
                        <li>Chat history stored locally on your device</li>
                        <li>Daily message usage counts for limited chats, stored locally</li>
                        <li>Your daily streak count and VIP status, stored in Firebase to sync across devices.</li>
                    </ul>
                    
                    <h3>Data Usage</h3>
                    <p>Your data is used to:</p>
                    <ul>
                        <li>Provide and improve our services</li>
                        <li>Personalize your experience</li>
                        <li>Maintain security and prevent abuse</li>
                        <li>Manage VIP features like the leaderboard and daily streak.</li>
                    </ul>
                    
                    <div class="highlight-box">
                        <p><i class="fas fa-exclamation-triangle"></i> <strong>Important</strong>: We never sell your personal data to third parties. Your chat history remains on your device unless you choose to share it.</p>
                    </div>
                    
                    <h3>Data Storage</h3>
                    <p>All your data is stored securely:</p>
                    <ul>
                        <li>Authentication handled by Firebase</li>
                        <li>User-specific data (streak, VIP status) stored in Firebase Realtime Database</li>
                        <li>Chat history and usage limits stored in your browser's local storage</li>
                        <li>Uploaded images are processed temporarily and never stored</li>
                    </ul>
                    
                    <h3>Changes to This Policy</h3>
                    <p>We may update this policy occasionally. Continued use of Squid AI constitutes acceptance of these changes.</p>
                    
                    <button class="back-button" id="backFromPrivacyPolicy">
                        <i class="fas fa-arrow-left"></i> Back to Settings
                    </button>
                </div>
            </div>
            
            <!-- Security Container -->
            <div class="info-container" id="securityContainer">
                 <div class="info-header">
                    <i class="fas fa-lock"></i>
                    <h2>Security Information</h2>
                </div>
                
                <div class="info-content">
                    <p>Squid AI is built with security as a top priority. Here's how we protect you:</p>
                    
                    <h3>Data Protection</h3>
                    <ul>
                        <li>End-to-end encryption for all communications</li>
                        <li>Secure authentication via Firebase</li>
                        <li>Regular security audits of our codebase</li>
                    </ul>
                    
                    <h3>Your Responsibilities</h3>
                    <p>To maintain your security:</p>
                    <ul>
                        <li>Use a strong, unique password</li>
                        <li>Never share your login credentials</li>
                        <li>Log out when using shared devices</li>
                        <li>Keep your device software updated</li>
                    </ul>
                    
                    <div class="highlight-box">
                        <p><i class="fas fa-shield-alt"></i> <strong>Security Tip</strong>: Squid AI will never ask for your password outside of the login screen. Be wary of any messages requesting personal information.</p>
                    </div>
                    
                    <h3>API Security</h3>
                    <p>Our AI integrations are secured through:</p>
                    <ul>
                        <li>API key encryption and rotation</li>
                        <li>Strict rate limiting to prevent abuse</li>
                        <li>Regular monitoring of API usage patterns</li>
                    </ul>
                    
                    <h3>Reporting Security Issues</h3>
                    <p>If you discover a security vulnerability:</p>
                    <ol>
                        <li>Do not publicly disclose the issue</li>
                        <li>Contact our security team at security@squidai.app</li>
                        <li>Provide detailed steps to reproduce the issue</li>
                    </ol>
                    
                    <p>We appreciate responsible disclosure and will respond promptly to all valid reports.</p>
                    
                    <button class="back-button" id="backFromSecurity">
                        <i class="fas fa-arrow-left"></i> Back to Settings
                    </button>
                </div>
            </div>
            
            <!-- IQ Game Container -->
            <div class="game-container" id="gameContainer">
                <div class="game-title">ðŸ§  Emoji IQ Finder</div>
                <div class="round-title" id="roundTitle">Tap the correct emoji!</div>
                <div class="timer-display" id="timerDisplay">â±ï¸ Time: 5</div>
                <div class="emoji-container" id="emojiContainer"></div>
                <button class="game-button" id="startGameButton">Start Game</button>
                <div class="iq-result" id="iqResult"></div>
                <button class="game-button" id="restartGameButton" style="display: none;">Play Again</button>
            </div>
        </div>

        <div class="bottom-nav">
            <div class="nav-item active" id="homeNav">
                <div class="nav-icon"><i class="fas fa-home"></i></div>
                <div class="nav-label">Home</div>
            </div>
            <div class="nav-item" id="newChatNav">
                <div class="nav-icon"><i class="fas fa-plus-circle"></i></div>
                <div class="nav-label">New Chat</div>
            </div>
            <div class="nav-item" id="leaderboardNav">
                <div class="nav-icon"><i class="fas fa-trophy"></i></div>
                <div class="nav-label">Leaderboard</div>
            </div>
        </div>
    </div>
    
    <!-- RESTORED: Ad Banner Container -->
    <div id="adBannerContainer">
      <div id="adContainer">
        <canvas id="backgroundCanvas"></canvas>
        <div id="adContent">
          <div class="header animated-entry" style="animation-delay: 0.2s;">
            <h1 class="title">Squid VIP Membership</h1>
            <p class="subtitle">Monthly VIP Membership</p>
          </div>
          <div class="features-container animated-entry" style="animation-delay: 0.4s;">
            <div class="features">
              <div class="feature">Show your name on global leaderboard</div>
              <div class="feature">2x limit increases on your language</div>
              <div class="feature">Get VIP badge on your profile</div>
              <div class="feature">Ad-free experience</div>
              <div class="feature">Unlock multiple VIP features</div>
            </div>
          </div>
          <div class="button-container animated-entry" style="animation-delay: 0.6s;">
            <button class="vip-button" id="adUnlockButton">Unlock VIP in just â‚¹59</button>
          </div>
        </div>
        <div id="adCountdown" class="countdown">8</div>
      </div>
    </div>
    
<script>
    // =================================================================================
    // IMPORTANT: Configuration
    // =================================================================================
    const COHERE_API_KEY = "bpSstiCTmvYvzPE396HFKbZABWTA8JfBpkHWMujA";
    const COHERE_API_ENDPOINT = "https://api.cohere.ai/v1/chat";
    
    const GEMINI_API_KEY = "AIzaSyAPACd3ci-fr96Iswt2HqoxStZm0mMCmtc"; 
    const GEMINI_MODEL = "gemini-1.5-flash-latest";
    const GEMINI_API_ENDPOINT = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;
    
    const DAILY_MESSAGE_LIMIT_NORMAL = 50; 
    const DAILY_MESSAGE_LIMIT_VIP = 100;
    const STREAK_REDEEM_GOAL = 30;

    const firebaseConfig = {
      apiKey: "AIzaSyCnS5bEqwCJHSwUkDbA3gWBRvL3o5OIrrw",
      authDomain: "chat-app-b07dc.firebaseapp.com",
      databaseURL: "https://chat-app-b07dc-default-rtdb.firebaseio.com",
      projectId: "chat-app-b07dc",
      storageBucket: "chat-app-b07dc.firebasestorage.app",
      messagingSenderId: "366248300706",
      appId: "1:366248300706:web:ca64e809e4f0ca52e747fb",
      measurementId: "G-4JZ3MQ9J7M"
    };

    const firebaseApp = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth(firebaseApp);
    const db = firebase.database(firebaseApp);

    // =================================================================================
    // DOM Element References
    // =================================================================================
    const loaderContainer = document.getElementById('loaderContainer');
    const loginContainer = document.getElementById('loginContainer');
    const appContainer = document.getElementById('appContainer');
    const emailInput = document.getElementById('emailInput');
    const passwordInput = document.getElementById('passwordInput');
    const authButton = document.getElementById('authButton');
    const toggleAuthModeLink = document.getElementById('toggleAuthModeLink');
    const formFooterText = document.getElementById('formFooterText');
    const emailError = document.getElementById('emailError');
    const passwordError = document.getElementById('passwordError');
    const generalError = document.getElementById('generalError');
    const settingsButton = document.getElementById('settingsButton');
    const logoutButton = document.getElementById('logoutButton');
    const mainContent = document.getElementById('mainContent');
    const settingsContainer = document.getElementById('settingsContainer');
    const gameContainer = document.getElementById('gameContainer');
    const homeNav = document.getElementById('homeNav');
    const newChatNav = document.getElementById('newChatNav');
    const themeToggle = document.getElementById('themeToggle');
    const chatHistoryList = document.getElementById('chatHistoryList');
    const noHistoryMessage = document.getElementById('noHistoryMessage');
    const appTitle = document.getElementById('appTitle');

    // Chat elements
    const chatContainer = document.getElementById('chatContainer');
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const sendButton = document.getElementById('sendButton');
    const chatButton = document.getElementById('chatButton');
    const learnButton = document.getElementById('learnButton');
    const codeButton = document.getElementById('codeButton');
    const adviceChatButton = document.getElementById('adviceChatButton');
    const adviceChatContainer = document.getElementById('adviceChatContainer');
    const adviceChatMessages = document.getElementById('adviceChatMessages');
    const adviceSuggestionsContainer = document.getElementById('adviceSuggestionsContainer');
    const adviceChatInput = document.getElementById('adviceChatInput');
    const adviceSendButton = document.getElementById('adviceSendButton');
    const adviceLimitCounter = document.getElementById('adviceLimitCounter');
    const hindiChatButton = document.getElementById('hindiChatButton');
    const hindiChatContainer = document.getElementById('hindiChatContainer');
    const hindiChatMessages = document.getElementById('hindiChatMessages');
    const hindiChatInput = document.getElementById('hindiChatInput');
    const hindiSendButton = document.getElementById('hindiSendButton');
    const hindiAttachmentButton = document.getElementById('hindiAttachmentButton');
    const hindiFileInput = document.getElementById('hindiFileInput');
    const hindiImagePreviewContainer = document.getElementById('hindiImagePreviewContainer');
    const hindiLimitCounter = document.getElementById('hindiLimitCounter');

    // IQ Game
    const iqButton = document.getElementById('iqButton');
    const roundTitle = document.getElementById('roundTitle');
    const timerDisplay = document.getElementById('timerDisplay');
    const emojiContainer = document.getElementById('emojiContainer');
    const startGameButton = document.getElementById('startGameButton');
    const restartGameButton = document.getElementById('restartGameButton');
    const iqResult = document.getElementById('iqResult');
    
    // Info & Settings Pages
    const howToUseBtn = document.getElementById('howToUseBtn');
    const privacyPolicyBtn = document.getElementById('privacyPolicyBtn');
    const securityBtn = document.getElementById('securityBtn');
    const howToUseContainer = document.getElementById('howToUseContainer');
    const privacyPolicyContainer = document.getElementById('privacyPolicyContainer');
    const securityContainer = document.getElementById('securityContainer');
    const backFromHowToUse = document.getElementById('backFromHowToUse');
    const backFromPrivacyPolicy = document.getElementById('backFromPrivacyPolicy');
    const backFromSecurity = document.getElementById('backFromSecurity');
    
    // Profile Page elements
    const profileBtn = document.getElementById('profileBtn');
    const profileContainer = document.getElementById('profileContainer');
    const profileEmail = document.getElementById('profileEmail');
    const profileNameInput = document.getElementById('profileNameInput');
    const saveNameButton = document.getElementById('saveNameButton');
    const resetPasswordButton = document.getElementById('resetPasswordButton');
    const profileStatus = document.getElementById('profileStatus');
    const backFromProfile = document.getElementById('backFromProfile');
    const profileVipBadge = document.getElementById('profileVipBadge');
    
    // Leaderboard and VIP elements
    const leaderboardNav = document.getElementById('leaderboardNav');
    const leaderboardContainer = document.getElementById('leaderboardContainer');
    const leaderboardList = document.getElementById('leaderboardList');
    const vipMembershipBtn = document.getElementById('vipMembershipBtn');
    const vipBtnText = document.getElementById('vipBtnText');
    const vipMembershipContainer = document.getElementById('vipMembershipContainer');
    const backFromVip = document.getElementById('backFromVip');
    const unlockVipPageButton = document.getElementById('unlockVipPageButton');
    
    // RESTORED: Ad Banner elements
    const adBannerContainer = document.getElementById('adBannerContainer');
    const adCountdown = document.getElementById('adCountdown');
    const adUnlockButton = document.getElementById('adUnlockButton');
    const backgroundCanvas = document.getElementById('backgroundCanvas');
    
    // Streak & Redemption elements
    const streakCounter = document.getElementById('streakCounter');
    const streakCount = document.getElementById('streakCount');
    const streakRedeemContainer = document.getElementById('streakRedeemContainer');
    const redeemStreakCount = document.getElementById('redeemStreakCount');
    const redeemStreakButton = document.getElementById('redeemStreakButton');

    // =================================================================================
    // App State
    // =================================================================================
    let currentUser = null;
    let isTyping = false;
    let isSignupMode = false;
    let currentChat = [];
    let currentAdviceChat = []; 
    let currentHindiChat = [];
    let activeChatType = 'english'; 
    let selectedHindiFile = null;
    let isVipUser = false;
    let userStreak = 0;
    
    // RESTORED: Ad Banner State
    let adInterval = null;
    let isAdShowing = false;
    let adCountdownTimer = null;

    // IQ Game State
    const rounds = [
        { correct: "ðŸ˜€", options: ["ðŸ˜€", "ðŸ˜ ", "ðŸ˜Ž", "ðŸ˜¢"] }, { correct: "ðŸ¶", options: ["ðŸ±", "ðŸ¶", "ðŸ­", "ðŸ°"] },
        { correct: "ðŸŽ", options: ["ðŸŽ", "ðŸŒ", "ðŸ‡", "ðŸ‰"] }, { correct: "ðŸš—", options: ["ðŸšŒ", "ðŸš—", "ðŸš•", "ðŸš“"] },
        { correct: "ðŸŒž", options: ["ðŸŒž", "ðŸŒœ", "â­", "â˜ï¸"] }, { correct: "â¤ï¸", options: ["ðŸ’™", "ðŸ’›", "ðŸ’œ", "â¤ï¸"] },
        { correct: "ðŸ™", options: ["ðŸ˜•", "ðŸ™", "ðŸ˜’", "ðŸ˜"] }, { correct: "ðŸ˜Ÿ", options: ["ðŸ˜Ÿ", "ðŸ˜‘", "ðŸ˜", "ðŸ˜®"] },
        { correct: "ðŸ˜•", options: ["ðŸ˜", "ðŸ˜•", "ðŸ˜’", "ðŸ™"] }, { correct: "ðŸ˜’", options: ["ðŸ˜’", "ðŸ˜", "ðŸ˜", "ðŸ™ƒ"] }
    ];
    const easyTime = 5;
    const hardTime = 3;
    let currentRound = 0;
    let gameScore = 0;
    let gameTimer;
    let timeLeft;

    // =================================================================================
    // Main App Logic & Authentication
    // =================================================================================

    auth.onAuthStateChanged(user => {
        loaderContainer.style.display = 'none';
        if (user) {
            currentUser = user;
            initializeAppState();
        } else {
            currentUser = null;
            showLogin();
        }
    });

    function initializeAppState() {
        showApp();
        fetchAndProcessUserData();
    }
    
    function setupEventListeners() {
        authButton.addEventListener('click', handleAuthAction);
        toggleAuthModeLink.addEventListener('click', (e) => { e.preventDefault(); toggleAuthMode(); });
        logoutButton.addEventListener('click', handleLogout);
        settingsButton.addEventListener('click', () => navigateTo('settings'));
        
        chatInput.addEventListener('keypress', e => { if (e.key === 'Enter' && !isTyping) sendMessage(); });
        sendButton.addEventListener('click', () => { if (!isTyping) sendMessage(); });
        chatButton.addEventListener('click', () => startChat());
        learnButton.addEventListener('click', () => startPresetChat("learn"));
        codeButton.addEventListener('click', () => startPresetChat("code"));

        adviceChatButton.addEventListener('click', () => startAdviceChat());
        adviceChatInput.addEventListener('keypress', e => { if (e.key === 'Enter' && !isTyping) sendAdviceMessage(); });
        adviceSendButton.addEventListener('click', () => { if (!isTyping) sendAdviceMessage(); });
        adviceSuggestionsContainer.addEventListener('click', handleSuggestionClick);

        hindiChatButton.addEventListener('click', () => startHindiChat());
        hindiChatInput.addEventListener('keypress', e => { if (e.key === 'Enter' && !isTyping) sendHindiMessage(); });
        hindiSendButton.addEventListener('click', () => { if (!isTyping) sendHindiMessage(); });
        hindiAttachmentButton.addEventListener('click', () => hindiFileInput.click());
        hindiFileInput.addEventListener('change', handleHindiFileSelect);

        homeNav.addEventListener('click', () => navigateTo('home'));
        newChatNav.addEventListener('click', () => startChat());
        iqButton.addEventListener('click', () => navigateTo('game'));
        themeToggle.addEventListener('change', toggleTheme);
        
        startGameButton.addEventListener('click', startGame);
        restartGameButton.addEventListener('click', startGame);
        
        howToUseBtn.addEventListener('click', () => showInfoPage('howToUse'));
        privacyPolicyBtn.addEventListener('click', () => showInfoPage('privacyPolicy'));
        securityBtn.addEventListener('click', () => showInfoPage('security'));
        backFromHowToUse.addEventListener('click', () => navigateTo('settings'));
        backFromPrivacyPolicy.addEventListener('click', () => navigateTo('settings'));
        backFromSecurity.addEventListener('click', () => navigateTo('settings'));
        
        profileBtn.addEventListener('click', () => showInfoPage('profile'));
        backFromProfile.addEventListener('click', () => navigateTo('settings'));
        saveNameButton.addEventListener('click', handleSaveName);
        resetPasswordButton.addEventListener('click', handleResetPassword);

        leaderboardNav.addEventListener('click', () => navigateTo('leaderboard'));
        vipMembershipBtn.addEventListener('click', () => showInfoPage('vipMembership'));
        backFromVip.addEventListener('click', () => navigateTo('settings'));
        unlockVipPageButton.addEventListener('click', () => {
            alert('VIP purchasing system is under development. Coming soon! Try redeeming with your daily streak.');
        });
        
        // RESTORED: Ad unlock button listener
        adUnlockButton.addEventListener('click', () => {
            hideVipAd();
            showInfoPage('vipMembership'); // Navigate directly to VIP page
        });
        
        redeemStreakButton.addEventListener('click', redeemVipWithStreak);
    }
    
    function showLogin() {
        loginContainer.style.display = 'block';
        appContainer.style.display = 'none';
        document.body.style.overflow = 'auto';
        emailInput.value = '';
        passwordInput.value = '';
        clearErrors();
        
        // RESTORED: Stop ad on logout
        if (adInterval) clearInterval(adInterval);
        hideVipAd(); // Ensure ad is hidden if it was showing
        
        isVipUser = false;
        userStreak = 0;
        updateStreakUI();
        updateVipRelatedUI();
    }

    function showApp() {
        loginContainer.style.display = 'none';
        appContainer.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        navigateTo('home');
        loadTheme();
    }

    function clearErrors() {
        emailError.style.display = 'none';
        passwordError.style.display = 'none';
        generalError.style.display = 'none';
        generalError.textContent = '';
    }

    async function handleAuthAction() {
        if (!validateInputs()) return;
        const email = emailInput.value;
        const password = passwordInput.value;
        authButton.disabled = true;
        authButton.textContent = 'Processing...';
        try {
            if (isSignupMode) { await auth.createUserWithEmailAndPassword(email, password); } 
            else { await auth.signInWithEmailAndPassword(email, password); }
        } catch (error) {
            console.error("Authentication error:", error);
            generalError.textContent = error.message;
            generalError.style.display = 'block';
        } finally {
            authButton.disabled = false;
            authButton.textContent = isSignupMode ? 'Sign Up' : 'Log In';
        }
    }

    function toggleAuthMode() {
        isSignupMode = !isSignupMode;
        clearErrors();
        if (isSignupMode) {
            authButton.textContent = 'Sign Up';
            formFooterText.textContent = 'Already have an account?';
            toggleAuthModeLink.textContent = 'Log In';
        } else {
            authButton.textContent = 'Log In';
            formFooterText.textContent = "Don't have an account?";
            toggleAuthModeLink.textContent = 'Sign Up';
        }
    }
    
    function handleLogout() {
        saveActiveChat();
        auth.signOut();
    }

    function validateInputs() {
        clearErrors();
        let isValid = true;
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailInput.value)) {
            emailError.style.display = 'block';
            isValid = false;
        }
        if (passwordInput.value.length < 6) {
            passwordError.style.display = 'block';
            isValid = false;
        }
        return isValid;
    }

    // =================================================================================
    // User Data Fetching and Processing
    // =================================================================================
    async function fetchAndProcessUserData() {
        if (!currentUser) return;
        try {
            const userRef = db.ref(`users/${currentUser.uid}`);
            const snapshot = await userRef.once('value');
            const userData = snapshot.val() || {};

            processVipStatus(userData);
            await processUserStreak(userData);

            updateVipRelatedUI();
            updateStreakUI();
            
            // RESTORED: Initialize ad logic based on the now-known VIP status
            if (adInterval) clearInterval(adInterval);
            if (!isVipUser) {
                adInterval = setInterval(showVipAd, 50000); // Show ad every 50 seconds for non-VIPs
            }
            
        } catch (error) {
            console.error("Error fetching user data:", error);
        }
    }
    
    function processVipStatus(userData) {
        if (userData && userData.isVip && userData.vipExpiryDate) {
            const expiryDate = new Date(userData.vipExpiryDate);
            if (expiryDate > new Date()) {
                isVipUser = true;
            } else {
                isVipUser = false;
                db.ref(`users/${currentUser.uid}`).update({ isVip: false, vipExpiryDate: null });
            }
        } else {
            isVipUser = false;
        }
    }

    async function processUserStreak(userData) {
        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];
        const lastLoginStr = userData.lastLoginDate;
        let currentStreak = userData.streak || 0;

        if (lastLoginStr) {
            if (lastLoginStr !== todayStr) {
                const yesterday = new Date(today);
                yesterday.setDate(today.getDate() - 1);
                const yesterdayStr = yesterday.toISOString().split('T')[0];

                currentStreak = (lastLoginStr === yesterdayStr) ? currentStreak + 1 : 1;
                await db.ref(`users/${currentUser.uid}`).update({ streak: currentStreak, lastLoginDate: todayStr });
            }
        } else {
            currentStreak = 1;
            await db.ref(`users/${currentUser.uid}`).update({ streak: currentStreak, lastLoginDate: todayStr });
        }
        userStreak = currentStreak;
    }
    
    // =================================================================================
    // VIP and Daily Streak Logic
    // =================================================================================
    async function redeemVipWithStreak() {
        if (!currentUser || userStreak < STREAK_REDEEM_GOAL) return;

        redeemStreakButton.disabled = true;
        redeemStreakButton.textContent = "Redeeming...";

        try {
            const expiryDate = new Date();
            expiryDate.setDate(expiryDate.getDate() + 30);

            const updates = {
                isVip: true,
                vipExpiryDate: expiryDate.toISOString(),
                streak: 0, 
            };
            
            await db.ref(`users/${currentUser.uid}`).update(updates);
            
            if(currentUser.displayName) {
                 await db.ref(`leaderboard/${currentUser.uid}`).set({
                    name: currentUser.displayName,
                    isVip: true
                 });
            }
            
            await fetchAndProcessUserData();
            alert("Congratulations! You've unlocked 1 Month of FREE VIP Membership!");
            navigateTo('settings');

        } catch(error) {
            console.error("Error redeeming streak:", error);
            alert("Could not redeem streak due to an error. Please try again later.");
            redeemStreakButton.disabled = false;
            redeemStreakButton.textContent = "Redeem for 1 Month FREE VIP";
        }
    }

    function updateStreakUI() {
        if (userStreak > 0) {
            streakCounter.style.display = 'flex';
            streakCount.textContent = userStreak;
            redeemStreakCount.textContent = userStreak;
        } else {
            streakCounter.style.display = 'none';
            redeemStreakCount.textContent = 0;
        }
        
        redeemStreakButton.disabled = userStreak < STREAK_REDEEM_GOAL;
    }

    function updateVipRelatedUI() {
        if (isVipUser) {
            vipMembershipBtn.classList.add('active-vip');
            vipBtnText.textContent = 'VIP Active';
        } else {
            vipMembershipBtn.classList.remove('active-vip');
            vipBtnText.textContent = 'VIP Membership';
        }
        profileVipBadge.style.display = isVipUser ? 'inline-block' : 'none';
    }


    // =================================================================================
    // Navigation Logic
    // =================================================================================
    function navigateTo(section) {
        if (chatContainer.style.display === 'flex' || hindiChatContainer.style.display === 'flex' || adviceChatContainer.style.display === 'flex') {
            saveActiveChat();
        }
        
        mainContent.style.display = 'none';
        chatContainer.style.display = 'none';
        hindiChatContainer.style.display = 'none';
        adviceChatContainer.style.display = 'none';
        settingsContainer.style.display = 'none';
        gameContainer.style.display = 'none';
        howToUseContainer.style.display = 'none';
        privacyPolicyContainer.style.display = 'none';
        securityContainer.style.display = 'none';
        profileContainer.style.display = 'none';
        leaderboardContainer.style.display = 'none';
        vipMembershipContainer.style.display = 'none';
        
        homeNav.classList.remove('active');
        newChatNav.classList.remove('active');
        leaderboardNav.classList.remove('active');

        if (section === 'home') {
            appTitle.textContent = "Squid AI";
            mainContent.style.display = 'flex';
            homeNav.classList.add('active');
            activeChatType = null;
        } else if (section === 'chat') {
            appTitle.textContent = "Squid AI";
            chatContainer.style.display = 'flex';
            newChatNav.classList.add('active');
            activeChatType = 'english';
        } else if (section === 'advice') {
            appTitle.textContent = "Your Friend";
            adviceChatContainer.style.display = 'flex';
            newChatNav.classList.add('active');
            activeChatType = 'advice';
        } else if (section === 'hindiChat') {
            appTitle.textContent = "Squid AI";
            hindiChatContainer.style.display = 'flex';
            newChatNav.classList.add('active');
            activeChatType = 'hindi';
        } else if (section === 'settings') {
            appTitle.textContent = "Settings";
            settingsContainer.style.display = 'flex';
            homeNav.classList.add('active');
            renderChatHistory();
        } else if (section === 'game') {
            appTitle.textContent = "IQ Calculator";
            gameContainer.style.display = 'flex';
            homeNav.classList.add('active');
            resetGame();
        } else if (section === 'leaderboard') {
            appTitle.textContent = "Leaderboard";
            leaderboardContainer.style.display = 'flex';
            leaderboardNav.classList.add('active');
            fetchAndRenderLeaderboard();
        } else if (section === 'vipMembership') {
            showInfoPage('vipMembership');
        }
    }
    
    function showInfoPage(page) {
        settingsContainer.style.display = 'none';
        howToUseContainer.style.display = 'none';
        privacyPolicyContainer.style.display = 'none';
        securityContainer.style.display = 'none';
        profileContainer.style.display = 'none';
        vipMembershipContainer.style.display = 'none';
        
        if (page === 'howToUse') {
            howToUseContainer.style.display = 'flex';
            appTitle.textContent = "How to Use";
        } else if (page === 'privacyPolicy') {
            privacyPolicyContainer.style.display = 'flex';
            appTitle.textContent = "Privacy Policy";
        } else if (page === 'security') {
            securityContainer.style.display = 'flex';
            appTitle.textContent = "Security";
        } else if (page === 'profile') {
            profileContainer.style.display = 'flex';
            appTitle.textContent = "Your Profile";
            loadProfileData();
        } else if (page === 'vipMembership') {
            vipMembershipContainer.style.display = 'flex';
            appTitle.textContent = "VIP Membership";
            updateStreakUI();
        }
    }

    // =================================================================================
    // Leaderboard Functions
    // =================================================================================
    async function fetchAndRenderLeaderboard() {
        leaderboardList.innerHTML = '<p>Loading leaderboard...</p>';

        try {
            const snapshot = await db.ref('leaderboard').orderByChild('isVip').equalTo(true).once('value');
            const data = snapshot.val();

            if (data) {
                const users = Object.keys(data)
                    .map(key => ({
                        id: key,
                        name: data[key].name,
                        isVip: data[key].isVip
                    }))
                    .filter(user => user.name);
                
                renderLeaderboard(users);
            } else {
                 leaderboardList.innerHTML = '<p style="text-align: center; color: #ccc;">Leaderboard is empty. <br>Become a VIP and set your name to appear here!</p>';
            }
        } catch (error) {
            console.error("Error fetching leaderboard:", error);
            leaderboardList.innerHTML = '<p>Could not load leaderboard.</p>';
        }
    }

    function renderLeaderboard(users) {
        leaderboardList.innerHTML = '';
        if (!users || users.length === 0) {
            leaderboardList.innerHTML = '<p style="text-align: center; color: #ccc;">Leaderboard is empty. <br>Become a VIP and set your name to appear here!</p>';
            return;
        }

        users.forEach((user, index) => {
            const li = document.createElement('li');
            li.className = 'leaderboard-item is-vip';
            li.innerHTML = `
                <span class="leaderboard-rank">${index + 1}</span>
                <span class="leaderboard-name">${user.name} <i class="fas fa-crown vip-badge"></i></span>
                <span class="leaderboard-score"><i class="fas fa-check-circle"></i> Member</span>
            `;
            leaderboardList.appendChild(li);
        });
    }

    // =================================================================================
    // Profile Page Functions
    // =================================================================================
    function loadProfileData() {
        if (!currentUser) return;
        profileEmail.textContent = currentUser.email;
        profileNameInput.value = currentUser.displayName || '';
        profileStatus.textContent = '';
        updateVipRelatedUI();
    }

    async function handleSaveName() {
        const newName = profileNameInput.value.trim();
        if (!newName) {
            profileStatus.textContent = "Name cannot be empty.";
            profileStatus.className = 'fail';
            return;
        }
        saveNameButton.disabled = true;
        saveNameButton.textContent = "Saving...";
        try {
            await currentUser.updateProfile({ displayName: newName });
            
            if (isVipUser) {
                await db.ref(`leaderboard/${currentUser.uid}`).set({
                    name: newName,
                    isVip: true
                });
            }

            profileStatus.textContent = "Name updated successfully!";
            profileStatus.className = 'success';
        } catch (error) {
            console.error("Error updating profile:", error);
            profileStatus.textContent = "Error: " + error.message;
            profileStatus.className = 'fail';
        } finally {
            saveNameButton.disabled = false;
            saveNameButton.textContent = "Save Name";
        }
    }

    async function handleResetPassword() {
        if (!currentUser || !currentUser.email) return;
        resetPasswordButton.disabled = true;
        try {
            await auth.sendPasswordResetEmail(currentUser.email);
            profileStatus.textContent = "Password reset link sent to your email.";
            profileStatus.className = 'success';
        } catch (error) {
            console.error("Error sending password reset email:", error);
            profileStatus.textContent = "Error: " + error.message;
            profileStatus.className = 'fail';
        } finally {
            setTimeout(() => { resetPasswordButton.disabled = false; }, 5000);
        }
    }

    // =================================================================================
    // Daily Limit Logic
    // =================================================================================
    function getLimitData(chatType) {
        if (!currentUser) return { count: 0, date: null };
        const todayStr = new Date().toISOString().split('T')[0];
        const key = `limit_${chatType}_${currentUser.uid}`;
        const data = JSON.parse(localStorage.getItem(key) || '{}');
        const limit = isVipUser ? DAILY_MESSAGE_LIMIT_VIP : DAILY_MESSAGE_LIMIT_NORMAL;

        if (data.date !== todayStr) {
            return { count: limit, date: todayStr };
        }
        return data;
    }

    function saveLimitData(chatType, data) {
        if (!currentUser) return;
        const key = `limit_${chatType}_${currentUser.uid}`;
        localStorage.setItem(key, JSON.stringify(data));
    }

    function useOneMessage(chatType) {
        let data = getLimitData(chatType);
        if (data.count > 0) {
            data.count--;
            saveLimitData(chatType, data);
            return true;
        }
        return false;
    }

    function updateLimitUI(chatType) {
        const data = getLimitData(chatType);
        const limit = isVipUser ? DAILY_MESSAGE_LIMIT_VIP : DAILY_MESSAGE_LIMIT_NORMAL;
        const counterEl = (chatType === 'advice') ? adviceLimitCounter : hindiLimitCounter;
        if (counterEl) {
            counterEl.textContent = `Limit: ${data.count}/${limit}`;
        }
    }

    function handleLimitReached(chatType) {
        let inputEl, sendBtn, attachmentBtn, messagesContainer;
        let limitOverMessage = "Daily limit reached. Come back tomorrow or redeem VIP for 2x limits!";
        if (chatType === 'advice') {
            [inputEl, sendBtn, messagesContainer] = [adviceChatInput, adviceSendButton, adviceChatMessages];
        } else if (chatType === 'hindi') {
            [inputEl, sendBtn, attachmentBtn, messagesContainer] = [hindiChatInput, hindiSendButton, hindiAttachmentButton, hindiChatMessages];
            limitOverMessage = "à¤¦à¥ˆà¤¨à¤¿à¤• à¤¸à¥€à¤®à¤¾ à¤¸à¤®à¤¾à¤ªà¥à¤¤à¥¤ 2x à¤¸à¥€à¤®à¤¾à¤“à¤‚ à¤•à¥‡ à¤²à¤¿à¤ à¤µà¥€à¤†à¤ˆà¤ªà¥€ à¤®à¥‡à¤‚ à¤…à¤ªà¤—à¥à¤°à¥‡à¤¡ à¤•à¤°à¥‡à¤‚!";
        }
        if (inputEl && sendBtn) {
            inputEl.disabled = true;
            sendBtn.disabled = true;
            if (attachmentBtn) attachmentBtn.disabled = true;
            const messageElement = createMessageElement(limitOverMessage, 'ai');
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
    }

    // =================================================================================
    // Standard English Chat Functions
    // =================================================================================
    function startChat() {
        navigateTo('chat');
        chatMessages.innerHTML = '';
        currentChat = [];
        addMessage("Hello! I'm Squid AI. How can I help you today?", 'ai');
    }

    function startPresetChat(type) {
        navigateTo('chat');
        chatMessages.innerHTML = '';
        currentChat = [];
        let prompt, aiGreeting;
        if (type === "learn") {
            prompt = "Tell me a fun fact about Artificial Intelligence.";
            aiGreeting = "Of course! Let's learn about AI. Here's a fun fact to start:";
        } else if (type === "code") {
            prompt = "Write a simple Python function to reverse a string.";
            aiGreeting = "Sure, I can help with that. Here is a Python function to get you started:";
        }
        addMessage(aiGreeting, 'ai');
        setTimeout(() => getAIResponse(prompt), 500);
    }
    
    async function sendMessage() {
        const messageText = chatInput.value.trim();
        if (!messageText || isTyping) return;
        addMessage(messageText, 'user');
        chatInput.value = '';
        await getAIResponse(messageText);
    }

    async function getAIResponse(prompt) {
        isTyping = true;
        simulateTyping(chatMessages);
        try {
            const chatHistory = currentChat.map(msg => ({
                role: msg.sender === 'user' ? "USER" : "CHATBOT",
                message: msg.text
            })).slice(0, -1);
            const response = await fetch(COHERE_API_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${COHERE_API_KEY}` },
                body: JSON.stringify({ message: prompt, chat_history: chatHistory, model: "command-r-plus", temperature: 0.7 })
            });
            removeTypingIndicator(chatMessages);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || `API Error: ${response.statusText}`);
            }
            const data = await response.json();
            if (data.text) addMessage(data.text, 'ai');
            else addMessage("I'm having trouble understanding. Could you please rephrase?", 'ai');
        } catch (error) {
            console.error('Cohere API Error:', error);
            removeTypingIndicator(chatMessages);
            addMessage("Sorry, I encountered an error: " + error.message, 'ai');
        } finally {
            isTyping = false;
        }
    }

    function addMessage(text, sender) {
        currentChat.push({ text, sender });
        const messageElement = createMessageElement(text, sender);
        chatMessages.appendChild(messageElement);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // =================================================================================
    // Advice Chat Functions
    // =================================================================================
    function startAdviceChat() {
        navigateTo('advice');
        adviceChatMessages.innerHTML = '';
        currentAdviceChat = [];
        addAdviceMessage("Hey dost! Main tumhara friend Squid AI hoon. Kya chal raha hai? You can tell me anything, I'm here for you.", 'ai');
        updateLimitUI('advice');
        const limitData = getLimitData('advice');
        if (limitData.count <= 0) {
            handleLimitReached('advice');
        } else {
            adviceChatInput.disabled = false;
            adviceSendButton.disabled = false;
        }
    }

    async function sendAdviceMessage() {
        const limitData = getLimitData('advice');
        if (limitData.count <= 0) {
            handleLimitReached('advice'); return;
        }
        const messageText = adviceChatInput.value.trim();
        if (!messageText || isTyping) return;
        if (useOneMessage('advice')) {
            updateLimitUI('advice');
            addAdviceMessage(messageText, 'user');
            adviceChatInput.value = '';
            await getAdviceResponse(messageText);
        } else {
            handleLimitReached('advice');
        }
    }

    function handleSuggestionClick(e) {
        if (e.target.classList.contains('suggestion-chip')) {
            const limitData = getLimitData('advice');
            if (limitData.count <= 0) {
                handleLimitReached('advice'); return;
            }
            if (useOneMessage('advice')) {
                updateLimitUI('advice');
                const messageText = e.target.textContent;
                addAdviceMessage(messageText, 'user');
                getAdviceResponse(messageText);
            } else {
                handleLimitReached('advice');
            }
        }
    }

    async function getAdviceResponse(prompt) {
        isTyping = true;
        simulateTyping(adviceChatMessages);
        try {
            const systemInstruction = {
              parts: [{text: "You are Squid AI, a friendly and emotional AI friend. Your user is looking for advice or just wants to chat. Respond in a caring, empathetic, and friendly tone. Use a mix of Hindi and English (Hinglish). Keep your responses conversational and supportive, like you're talking to a close friend. Make them feel heard and understood."}]
            };
            const contents = currentAdviceChat.map(msg => ({
                role: msg.sender === 'user' ? "user" : "model",
                parts: [{ text: msg.text }]
            }));
            const response = await fetch(GEMINI_API_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: contents, system_instruction: systemInstruction,
                    generationConfig: { temperature: 0.9, topK: 1, topP: 1, maxOutputTokens: 2048 },
                })
            });
            removeTypingIndicator(adviceChatMessages);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error.message || `API Error: ${response.status}`);
            }
            const data = await response.json();
            const aiReply = data?.candidates?.[0]?.content?.parts?.[0]?.text;
            if (aiReply) {
                addAdviceMessage(aiReply, 'ai');
            } else {
                addAdviceMessage("Yaar, I'm a bit confused. Can you say that again in a different way?", 'ai');
            }
        } catch (error) {
            console.error('Gemini API Error (Advice Chat):', error);
            removeTypingIndicator(adviceChatMessages);
            addAdviceMessage("Sorry yaar, kuch technical problem ho gayi: " + error.message, 'ai');
        } finally {
            isTyping = false;
        }
    }

    function addAdviceMessage(text, sender) {
        currentAdviceChat.push({ text, sender });
        const messageElement = createMessageElement(text, sender);
        adviceChatMessages.appendChild(messageElement);
        adviceChatMessages.scrollTop = adviceChatMessages.scrollHeight;
    }

    // =================================================================================
    // Hindi Chat Functions
    // =================================================================================
    function startHindiChat() {
        navigateTo('hindiChat');
        hindiChatMessages.innerHTML = '';
        currentHindiChat = [];
        clearHindiPreview();
        addHindiMessage("à¤¨à¤®à¤¸à¥à¤¤à¥‡! à¤®à¥ˆà¤‚ à¤¸à¥à¤•à¥à¤µà¤¿à¤¡ à¤à¤†à¤ˆ à¤¹à¥‚à¤à¥¤ à¤†à¤ª à¤•à¥‹à¤ˆ à¤¤à¤¸à¥à¤µà¥€à¤° à¤­à¥‡à¤œ à¤¸à¤•à¤¤à¥‡ à¤¹à¥ˆà¤‚ à¤¯à¤¾ à¤®à¥à¤à¤¸à¥‡ à¤•à¥à¤› à¤ªà¥‚à¤› à¤¸à¤•à¤¤à¥‡ à¤¹à¥ˆà¤‚à¥¤", 'ai');
        updateLimitUI('hindi');
        const limitData = getLimitData('hindi');
        if (limitData.count <= 0) {
            handleLimitReached('hindi');
        } else {
            hindiChatInput.disabled = false;
            hindiSendButton.disabled = false;
            hindiAttachmentButton.disabled = false;
        }
    }

    async function sendHindiMessage() {
        const limitData = getLimitData('hindi');
        if (limitData.count <= 0) {
            handleLimitReached('hindi'); return;
        }
        const messageText = hindiChatInput.value.trim();
        const fileToSend = selectedHindiFile;
        if ((!messageText && !fileToSend) || isTyping) return;
        if (useOneMessage('hindi')) {
            updateLimitUI('hindi');
            addHindiMessage(messageText, 'user', fileToSend ? fileToSend.base64 : null);
            hindiChatInput.value = '';
            clearHindiPreview();
            await getGeminiHindiResponse(messageText, fileToSend);
        } else {
            handleLimitReached('hindi');
        }
    }
    
    function handleHindiFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;
        const validImageTypes = ['image/jpeg', 'image/png', 'image/webp'];
        if (!validImageTypes.includes(file.type)) {
            alert('Please select a valid image file (JPEG, PNG, or WEBP).');
            return;
        }
        const reader = new FileReader();
        reader.onload = function(e) {
            selectedHindiFile = { base64: e.target.result, mimeType: file.type };
            displayHindiImagePreview(e.target.result);
        };
        reader.readAsDataURL(file);
    }
    
    function displayHindiImagePreview(imageDataUrl) {
        hindiImagePreviewContainer.innerHTML = `<div class="image-preview"><button class="remove-preview-btn" title="Remove image">Ã—</button><img src="${imageDataUrl}" alt="Image preview"></div>`;
        hindiImagePreviewContainer.querySelector('.remove-preview-btn').addEventListener('click', clearHindiPreview);
    }

    function clearHindiPreview() {
        selectedHindiFile = null;
        hindiFileInput.value = '';
        hindiImagePreviewContainer.innerHTML = '';
    }

    async function getGeminiHindiResponse(prompt, file) {
        isTyping = true;
        simulateTyping(hindiChatMessages);
        try {
            const parts = [];
            if (prompt) parts.push({ text: prompt });
            if (file) parts.push({ inline_data: { mime_type: file.mimeType, data: file.base64.split(',')[1] } });
            const response = await fetch(GEMINI_API_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: parts }] })
            });
            removeTypingIndicator(hindiChatMessages);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error.message || `API Error: ${response.status}`);
            }
            const data = await response.json();
            const aiReply = data?.candidates?.[0]?.content?.parts?.[0]?.text || "à¤®à¤¾à¤«à¤¼ à¤•à¥€à¤œà¤¿à¤¯à¥‡, à¤®à¥à¤à¥‡ à¤•à¥‹à¤ˆ à¤ªà¥à¤°à¤¤à¤¿à¤•à¥à¤°à¤¿à¤¯à¤¾ à¤¨à¤¹à¥€à¤‚ à¤®à¤¿à¤²à¥€à¥¤";
            addHindiMessage(aiReply, 'ai');
        } catch (error) {
            console.error('Gemini API Error (Hindi Chat):', error);
            removeTypingIndicator(hindiChatMessages);
            addHindiMessage("à¤®à¤¾à¤«à¤¼ à¤•à¥€à¤œà¤¿à¤¯à¥‡, à¤à¤• à¤¤à¥à¤°à¥à¤Ÿà¤¿ à¤¹à¥à¤ˆ: " + error.message, 'ai');
        } finally {
            isTyping = false;
        }
    }

    function addHindiMessage(text, sender, imageUrl = null) {
        currentHindiChat.push({ text, sender, imageUrl });
        const messageElement = createMessageElement(text, sender, imageUrl);
        hindiChatMessages.appendChild(messageElement);
        hindiChatMessages.scrollTop = hindiChatMessages.scrollHeight;
    }

    // =================================================================================
    // Helper Functions for Chat UI
    // =================================================================================
    function createMessageElement(text, sender, imageUrl = null) {
        const messageElement = document.createElement('div');
        messageElement.classList.add('message', `${sender}-message`);
        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        let messageContent = '';
        if (imageUrl) {
            messageContent += `<img src="${imageUrl}" class="message-image" alt="User upload">`;
        }
        if (text) {
            const textNode = document.createElement('div');
            textNode.innerText = text;
            messageContent += `<div>${textNode.innerHTML.replace(/\n/g, '<br>')}</div>`;
        }
        messageElement.innerHTML = `${messageContent}<div class="message-time">${time}</div>`;
        return messageElement;
    }

    function simulateTyping(messagesContainer) {
        const typingElement = document.createElement('div');
        typingElement.classList.add('typing-indicator');
        typingElement.innerHTML = `<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>`;
        messagesContainer.appendChild(typingElement);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function removeTypingIndicator(messagesContainer) {
        const typingIndicator = messagesContainer.querySelector('.typing-indicator');
        if (typingIndicator) typingIndicator.remove();
    }
    
    // =================================================================================
    // IQ Game Functions
    // =================================================================================
    function resetGame() {
        currentRound = 0; gameScore = 0;
        startGameButton.style.display = 'block';
        restartGameButton.style.display = 'none';
        iqResult.textContent = '';
        roundTitle.textContent = 'Tap the correct emoji!';
        timerDisplay.textContent = 'â±ï¸ Time: 5';
        emojiContainer.innerHTML = '';
    }
    function startGame() {
        currentRound = 0; gameScore = 0;
        startGameButton.style.display = 'none';
        restartGameButton.style.display = 'none';
        iqResult.textContent = '';
        nextRound();
    }
    function nextRound() {
        if (currentRound >= rounds.length) { endGame(); return; }
        const round = rounds[currentRound];
        roundTitle.textContent = `Round ${currentRound + 1}: Tap ${round.correct}`;
        emojiContainer.innerHTML = '';
        round.options.sort(() => Math.random() - 0.5).forEach(emoji => {
            const span = document.createElement("span");
            span.textContent = emoji; span.className = "emoji";
            span.onclick = () => handleAnswer(emoji);
            emojiContainer.appendChild(span);
        });
        timeLeft = currentRound >= 6 ? hardTime : easyTime;
        updateTimer();
        gameTimer = setInterval(() => {
            timeLeft--; updateTimer();
            if (timeLeft <= 0) { clearInterval(gameTimer); currentRound++; nextRound(); }
        }, 1000);
    }
    function updateTimer() { timerDisplay.textContent = `â±ï¸ Time: ${timeLeft}`; }
    function handleAnswer(emoji) {
        if (emoji === rounds[currentRound].correct) gameScore++;
        clearInterval(gameTimer); currentRound++; nextRound();
    }
    function endGame() {
        emojiContainer.innerHTML = '';
        roundTitle.textContent = "Game Over!";
        timerDisplay.textContent = "";
        let iq;
        if (gameScore <= 3) iq = randomBetween(100, 110);
        else if (gameScore <= 6) iq = randomBetween(111, 125);
        else if (gameScore <= 8) iq = randomBetween(126, 139);
        else iq = randomBetween(140, 150);
        iqResult.textContent = `ðŸ§  Your IQ is: ${iq}`;
        restartGameButton.style.display = 'block';
    }
    function randomBetween(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

    // =================================================================================
    // Theme Persistence
    // =================================================================================
    function toggleTheme() {
        document.body.classList.toggle('light-mode');
        localStorage.setItem('theme', document.body.classList.contains('light-mode') ? 'light' : 'dark');
    }
    function loadTheme() {
        const theme = localStorage.getItem('theme');
        if (theme === 'light') {
            document.body.classList.add('light-mode');
            themeToggle.checked = true;
        } else {
            document.body.classList.remove('light-mode');
            themeToggle.checked = false;
        }
    }
    
    // =================================================================================
    // Chat History Logic
    // =================================================================================
    function getHistory() {
        if (!currentUser) return [];
        return JSON.parse(localStorage.getItem(`chatHistory_${currentUser.uid}`) || '[]');
    }
    
    function saveHistory(history) {
        if (!currentUser) return;
        localStorage.setItem(`chatHistory_${currentUser.uid}`, JSON.stringify(history));
    }

    function saveActiveChat() {
        let chatToSave, lang;
        if (activeChatType === 'english') { [chatToSave, lang] = [currentChat, 'en']; } 
        else if (activeChatType === 'hindi') { [chatToSave, lang] = [currentHindiChat, 'hi']; } 
        else if (activeChatType === 'advice') { [chatToSave, lang] = [currentAdviceChat, 'advice']; } 
        else { return; }
        
        if (chatToSave && chatToSave.length > 1) {
            const history = getHistory();
            const userMessages = chatToSave.filter(m => m.sender === 'user');
            let title = lang === 'hi' ? "à¤¹à¤¿à¤‚à¤¦à¥€ à¤šà¥ˆà¤Ÿ" : (lang === 'advice' ? "Advice Session" : "Chat");
            if (userMessages.length > 0) {
                 title = userMessages[0].text || (userMessages[0].imageUrl ? "Image Chat" : title);
            }
            history.unshift({
                id: Date.now(),
                title: title.substring(0, 40) + (title.length > 40 ? '...' : ''),
                messages: chatToSave,
                lang: lang
            });
            saveHistory(history.slice(0, 50));
            if(activeChatType === 'english') currentChat = [];
            if(activeChatType === 'hindi') { currentHindiChat = []; clearHindiPreview(); }
            if(activeChatType === 'advice') currentAdviceChat = [];
        }
    }

    function renderChatHistory() {
        chatHistoryList.innerHTML = '';
        const history = getHistory();
        noHistoryMessage.style.display = history.length === 0 ? 'block' : 'none';
        history.forEach(chat => {
            const li = document.createElement('li');
            li.className = 'history-item';
            let langBadge = '';
            if(chat.lang === 'hi') langBadge = '<span class="lang-badge">à¤¹à¤¿</span>';
            if(chat.lang === 'advice') langBadge = '<span class="lang-badge" title="Advice Chat"><i class="fas fa-hand-holding-heart"></i></span>';
            li.innerHTML = `
                <div style="display: flex; align-items: center; overflow: hidden;">
                    ${langBadge}
                    <span class="history-title">${chat.title}</span>
                </div>
                <div class="history-actions">
                    <button class="view-btn" title="View"><i class="fas fa-eye"></i></button>
                    <button class="delete-btn" title="Delete"><i class="fas fa-trash"></i></button>
                </div>`;
            li.querySelector('.view-btn').addEventListener('click', () => loadChatFromHistory(chat.id));
            li.querySelector('.delete-btn').addEventListener('click', (e) => { e.stopPropagation(); deleteChatFromHistory(chat.id); });
            chatHistoryList.appendChild(li);
        });
    }

    function loadChatFromHistory(chatId) {
        const history = getHistory();
        const chat = history.find(c => c.id === chatId);
        if (chat) {
            if (chat.lang === 'hi') {
                startHindiChat(); 
                currentHindiChat = chat.messages;
                hindiChatMessages.innerHTML = '';
                chat.messages.forEach(msg => addHindiMessage(msg.text, msg.sender, msg.imageUrl));
            } else if (chat.lang === 'advice') {
                startAdviceChat(); 
                currentAdviceChat = chat.messages;
                adviceChatMessages.innerHTML = '';
                chat.messages.forEach(msg => addAdviceMessage(msg.text, msg.sender));
            } else {
                startChat(); 
                currentChat = chat.messages;
                chatMessages.innerHTML = '';
                chat.messages.forEach(msg => addMessage(msg.text, msg.sender));
            }
        }
    }
    
    function deleteChatFromHistory(chatId) {
        let history = getHistory().filter(c => c.id !== chatId);
        saveHistory(history);
        renderChatHistory();
    }
    
    // =================================================================================
    // RESTORED: Ad Banner Logic
    // =================================================================================
    function initializeAdLogic() {
        const canvas = backgroundCanvas;
        if(!canvas || !canvas.getContext) return; // Don't run if canvas not found or supported
        const ctx = canvas.getContext('2d');
        let particles = [];
        function resizeCanvas() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
        }
        class Particle {
            constructor() { this.x = Math.random() * canvas.width; this.y = Math.random() * canvas.height; this.vx = (Math.random() - 0.5) * 0.5; this.vy = (Math.random() - 0.5) * 0.5; this.radius = Math.random() * 2 + 1; this.color = `rgba(255, 215, 0, ${Math.random() * 0.5 + 0.2})`; }
            draw() { ctx.beginPath(); ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2); ctx.fillStyle = this.color; ctx.fill(); }
            update() { this.x += this.vx; this.y += this.vy; if (this.x < 0 || this.x > canvas.width) this.vx *= -1; if (this.y < 0 || this.y > canvas.height) this.vy *= -1; }
        }
        function initParticles() {
            particles = [];
            const numParticles = Math.floor((canvas.width * canvas.height) / 10000);
            for (let i = 0; i < numParticles; i++) { particles.push(new Particle()); }
        }
        function animate() {
            if (!isAdShowing) return; // Stop animation if ad is hidden
            requestAnimationFrame(animate);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            gradient.addColorStop(0, '#4B0082'); gradient.addColorStop(0.5, '#8A2BE2'); gradient.addColorStop(1, '#000000');
            ctx.fillStyle = gradient; ctx.fillRect(0, 0, canvas.width, canvas.height);
            particles.forEach(p => { p.update(); p.draw(); });
        }
        window.addEventListener('resize', () => { if(isAdShowing) { resizeCanvas(); initParticles(); } });
        
        // Initial setup
        resizeCanvas();
        initParticles();
        animate(); // Start animation loop
    }

    function showVipAd() {
        if (isVipUser || isAdShowing || gameContainer.style.display === 'flex' || !currentUser) {
            return; // Don't show ad
        }
        isAdShowing = true;
        adBannerContainer.style.display = 'flex';
        initializeAdLogic(); // Start/Restart animation
        
        let count = 8;
        adCountdown.textContent = count;
        
        if (adCountdownTimer) clearInterval(adCountdownTimer);
        adCountdownTimer = setInterval(() => {
            count--;
            adCountdown.textContent = count;
            adCountdown.classList.add('tick');
            setTimeout(() => adCountdown.classList.remove('tick'), 300);

            if (count <= 0) {
                hideVipAd();
            }
        }, 1000);
    }
    
    function hideVipAd() {
        if(adCountdownTimer) clearInterval(adCountdownTimer);
        adBannerContainer.style.display = 'none';
        isAdShowing = false;
    }

    // =================================================================================
    // Start the App
    // =================================================================================
    setupEventListeners();

</script>
</body>
</html>